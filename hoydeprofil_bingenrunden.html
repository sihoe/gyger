<script>
async function loadElevationData() {
    const response = await fetch("https://raw.githubusercontent.com/sihoe/gyger/main/elevation_data.json");
    const rawData = await response.json();

    // Sorterer data etter avstand
    rawData.sort((a, b) => a.distance - b.distance);

    // Fjern punkter uten høyde (POI-er) fra datasettet
    const elevationData = rawData.filter(d => d.elevation !== null);

    // Klargjør data
    const distances = elevationData.map(d => d.distance);
    const elevations = elevationData.map(d => d.elevation);

    // Nøkkeltallberegninger
    const totalDistance = distances[distances.length - 1];
    const highestPoint = Math.max(...elevations);
    const lowestPoint = Math.min(...elevations);
    let totalAscent = 0, totalDescent = 0;

    for (let i = 1; i < elevations.length; i++) {
        const diff = elevations[i] - elevations[i - 1];
        if (diff > 0) totalAscent += diff;
        else totalDescent += Math.abs(diff);
    }

    // Oppdater nøkkeltall i HTML
    document.getElementById('totalDistance').innerText = totalDistance.toFixed(1);
    document.getElementById('totalAscent').innerText = totalAscent.toFixed(0);
    document.getElementById('totalDescent').innerText = totalDescent.toFixed(0);
    document.getElementById('highestPoint').innerText = highestPoint.toFixed(0);
    document.getElementById('lowestPoint').innerText = lowestPoint.toFixed(0);

    // Kalkuler bakgrunnsfarger
    let segmentColors = elevations.map((_, i) => {
        if (i === 0) return 'rgba(0,0,0,0)';
        const diffElev = elevations[i] - elevations[i-1];
        const diffDist = (distances[i] - distances[i-1]) * 1000;
        const slope = (diffElev / diffDist) * 100;
        if (slope > 5) return '#e15241';
        if (slope > 2.5) return '#f7be4f';
        return '#dddfe4';
    });

    // Chart.js - Viser grafen
    const ctx = document.getElementById('elevationChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: distances,
            datasets: [{
                label: 'Høyde (moh)',
                data: elevations,
                borderColor: '#422426',
                backgroundColor: '#dddfe4',
                fill: {
                    target: 'origin',
                    above: context => segmentColors[context.p0DataIndex],
                },
                tension: 0.3,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: context => {
                            const i = context.dataIndex;
                            const elev = elevations[i].toFixed(0);
                            const km = distances[i].toFixed(1);
                            const slope = i > 0 ? (((elevations[i] - elevations[i-1]) / ((distances[i] - distances[i-1])*1000))*100).toFixed(1) : '0';
                            return `Høyde: ${elev} moh, Km: ${km}, Stigning: ${slope}%`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Km' },
                    ticks: { callback: v => `${v} km`, stepSize: 2 }
                },
                y: { title: { display: true, text: 'Høyde (moh)' } }
            }
        }
    });
}

loadElevationData();
</script>
